# PN532 红板子与 Uno 初体验
- date: 2021-11-03
- lastmod: 2022-04-17

## 流程
- 焊接
- 选择通信方式
- 接线
- 烧录代码

![PN532 V3 正反面照片](https://www.electroschematics.com/wp-content/uploads/2019/04/2-PN532-Module-V3_Closeup-550x252.jpg)

# NFC 卡片

大体有 IC、ID、CPU 卡，目前广泛使用的是 IC 卡，讲卡片放在灯光下透视观察天线形状，圆形的多为 ID 卡，矩形的多为 IC 卡。

除了门禁（解锁）功能外还带有消费功能的 IC 卡多会采用网络同步，因此不要动歪脑筋。

- [钢铁侠水滴门禁卡。 2021](https://lceda.cn/liujigang/shuidimenjinka)
> IC卡种类简介  
普通M1卡：0扇区不可以修改，其他扇区可反复擦写，我们使用的电梯卡、门禁卡等智能卡发卡商所使用的都是 M1 卡，不是复制卡，可以理解为物业发的原卡，是被复制卡。  
UID 卡：普通复制卡，可以重复擦写所有扇区，主要应用在IC卡复制上，遇到带有防火墙的读卡器就会失效。  
CUID卡：可擦写防屏蔽复制卡，可以重复擦写所有扇区，UID卡复制无效的情况下使用，可以绕过防火墙。  
FUID卡：不可擦写防屏蔽复制卡，此卡的特点0扇区只能写入一次，写入一次变成 M1 卡，CUID 复制没用的情况下使用，可以绕过防火墙。  
UFUID卡：高级复制卡，可以理解为是 UID 和 FUID 的合成卡，需要封卡操作，不封卡就是 UID 卡，封卡后就变为 M1 卡。  
更多关于 UID 防火墙的信息可以阅读原文。

## 卡的结构
IC卡的一种，可以进行加密，容量为1k，有16个扇区(0~15)，每个扇区又分为四个区块（0～3），算下来每一个块的大小就是 16 byte。0 扇区的首个块写入的是卡号和厂商信息，这个块一般不可修改，CUID、UID 等卡可以修改该区块来复制卡号，以达到模拟门禁的情况。每个扇区的最后一个区块（对于下面的区块3、7、11等）存放着该扇区的两个密钥和存取控制位，不建议修改，否则将无法修改或读取该扇区的数据。也就是说，每个扇区的 0～2 共三个区块可读写（S0B0 特殊除外），而每个扇区的最后一个区块是保存读取权限，慎重修改，也就是可写的大小为 768 byte。

下面是一个 CUID 卡的全部扇区数据，可以看到卡号（UID Value）是扇区0（Sector 0）区块0（Block 0）的前四个字节。

```
Found an ISO14443A card
  UID Length: 4 bytes
  UID Value: 0x66 0xA0 0x52 0x41

Seems to be a Mifare Classic card (4 byte UID)
------------------------Sector 0-------------------------
Block 0  66 A0 52 41 D5 08 04 00 62 63 64 65 66 67 68 69  f⸮RA⸮...bcdefghi
Block 1  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 2  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 3  00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 1-------------------------
Block 4  61 64 61 66 72 75 69 74 2E 63 6F 6D 41 00 00 00  adafruit.comA...
Block 5  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 6  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 7  00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 2-------------------------
Block 8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 9  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 11 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 3-------------------------
Block 12 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 13 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 14 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 15 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 4-------------------------
Block 16 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 17 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 18 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 19 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 5-------------------------
Block 20 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 21 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 22 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 23 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 6-------------------------
Block 24 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 25 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 26 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 27 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 7-------------------------
Block 28 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 29 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 31 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 8-------------------------
Block 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 34 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 35 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 9-------------------------
Block 36 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 37 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 38 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 39 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 10-------------------------
Block 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 41 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 42 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 43 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 11-------------------------
Block 44 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 45 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 46 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 47 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 12-------------------------
Block 48 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 49 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 50 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 51 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 13-------------------------
Block 52 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 53 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 54 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 55 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 14-------------------------
Block 56 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 57 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 58 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 59 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
------------------------Sector 15-------------------------
Block 60 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 61 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 62 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
Block 63 00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF  ......⸮.⸮i⸮⸮⸮⸮⸮⸮
```

### S0B0

在上面的卡中，首个扇区的首个区块的数据是 `66 A0 52 41 D5 08 04 00 62 63 64 65 66 67 68 69`，前四个字节的数据代表了卡号，第五个字节的数据（`D5`）代表卡号的异或值，第六个字节（`08`）代表芯片类型。

### 权限

从上面的全部扇区数据可以轻易看出每个扇区的权限控制块的内容都一样，都是 `00 00 00 00 00 00 FF 07 80 69 FF FF FF FF FF FF`。

前六个字节是 密钥A (`00 00 00 00 00 00`)，第 7~10 字节的数据（`FF 07 80 69`）是存取控制位，最后六个字节存的是 密钥B（`FF FF FF FF FF FF`）。

- [M1卡存取控制字节规则详解. 木之泪 2018-12-26](https://blog.csdn.net/weixin_40600325/article/details/85250435)：写的很详细，外行最好还是用工具。
# 案例
## MifareOneTool
图形化操作，没啥难的，用这个就行了。

## arduino Adafruit PN532
这个接线烧录就行，将 PN532 调节到 I2C/SPI 模式。比如 mifareclassic_memdump 运行之后能读卡，读出来的结果和 卡的结构 一节中提到的全部扇区数据相似。写入 0 块不太好操作。

## mfoc
这个软件安装之后是通过终端进行操作的，需要有 USB转TTL 的工具，同时将 PN532 调节到 HSU 模式

```bash
sudo cp /etc/nfc/libnfc.conf.sample /etc/nfc/libnfc.conf  # 复制配置文件模板
sudo nano /etc/nfc/libnfc.conf  # 修改默认配置，去掉 allow_autoscan = true 前面的井号，将最后面两行 device.name 和 device.connstring 的注释去掉，端口自行确认

nfc-list  # 此时可以读取到设备和卡号信息(把卡贴上去)，如下所示
# nfc-list uses libnfc 1.8.0
# NFC device: microBuilder.eu opened
# 1 ISO14443A passive target(s) found:
# ISO/IEC 14443A (106 kbps) target:
#     ATQA (SENS_RES): 00  04  
#        UID (NFCID1): 50  e7  a4  09  
#       SAK (SEL_RES): 08 

mfoc -O card.mfd  # 读取卡信息到二进制文件 carf.mfd，读出来的信息和 mifareclassic_memdump 一致
nfc-mfsetuid bac3a6a3 # 修改卡号为 bac3a6a3
```

当我用 mfoc 读取卡信息时，然后手动修改二进制文件里的卡号+异或值，再用 nfc-mfclassic 烧录进去发现卡号还是没变，重新计算异或试了好几遍，最后看到下面的帖子果断直接用 nfc-mfsetuid 修改卡号。这样就不用带着硕大的校园卡开门禁、刷饭卡（小程序支付）、打水（小程序扣费），校园卡（CPU卡）只拿去澡堂就好了，丢了还心疼补卡费。

- [ Mifare Classic 1K智能卡介绍及nfc-tools的使用 2016-11-12](https://fanzheng.org/archives/30#4)
>   nfc-list.exe，查看一下卡有没有正常读取。
>   nfc-mfsetuid.exe，修改卡的UID。
>   nfc-mfclassic.exe，修改卡的数据。

### FAQ
#### No NFC device found
没有修改配置文件 /etc/nfc/libnfc.conf，我用的是下面的配置

```conf
allow_autoscan = true
device.name = "microBuilder.eu"
device.connstring = "pn532_uart:/dev/ttyUSB0"
```

# 参考

- [PN532 NFC RFID module for Arduino. 2017-07-19](https://osoyoo.com/2017/07/19/pn532-nfc-rfid-module-for-arduino/):用 Uno 借助 Adafruit-PN532 库通过 SPI 方式读取卡号和全部扇区数据
- [PN532 NFC RFID Module — A Quick Introduction](https://www.electroschematics.com/nfc-rfid-module-pn532/)：用 Uno 软串口通过 HSU 通信（有解释），也讲了和上面一样的 SPI,
- [Adafruit-PN532 库](https://github.com/adafruit/Adafruit-PN532/)：v1.2.2 暂时不支持写入数据
- [钢铁侠水滴门禁卡。 2021](https://lceda.cn/liujigang/shuidimenjinka)
- [IC卡与ID卡的区别是什么？](https://zhuanlan.zhihu.com/p/421444096): ID 无存储功能，只能存卡号
- [校园卡(NFC卡)文章的整理. cbirdfly. 2020-08-17](https://cbirdfly.blog.csdn.net/article/details/108052647)
- [M1卡存取控制字节规则详解. 木之泪 2018-12-26](https://blog.csdn.net/weixin_40600325/article/details/85250435)
