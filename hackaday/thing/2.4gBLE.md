# 2.4g 和 蓝牙BLE 的键鼠延迟探究
- date: 2022-10-30
- lastmod: 2022-10-30

对于办公而言，两种方式都可以满足正常需求，一下内容仅仅是做探究而查阅。我的键鼠都是米家的2.4gBLE双模，一个2.4g坏了，另一个是BLE耗电比。4g高，通常鼠标蓝牙都没法工作的时候，调节到2.4g还能再战几分钟，既然功耗体现出差别了，那我就在想延迟的差别有多少呢？

HID 和 PS/2 的区别，本次不做探究。

Egahp 在科普中讲到：键盘延迟 = 轴体触发延迟+电路延迟+去抖延迟（可避免）+数据处理延迟+数据链路传输延迟+PC端处理延迟。那么针对一款键鼠一款电脑而言，2.4g和BLE变化的延迟在于“数据链路传输延迟”，那么怎么测量呢？六6鱼采取的方式是电脑发送信号给单片机、单片机控制按键导通，电脑记录下时间间隔，切换2.4g和BLE对比平均时间间隔，该时间间隔不等于“数据链路传输延迟”，但是可以大概估计延迟的数量级。六6鱼的测试结果表明2.4g还是优于BLE。


# Interval 轮询率

HID Usage Tables 1.3 03/01/2022 431页搜索 interval,在 p273 Minimum Report Interval 单位为毫秒，数据类型是SV（静态数据），可以设置，没有找到最小数值（懒）

BLE Interval 在网络帖子查到的是 7.5ms～4s(1.25 ms单位间隔)

2.4g Interval 没查到

# 相关阅读

[[科普]关于键盘延迟的一些知识 2020.11.24 by Egahp](https://www.zfrontier.com/app/flow/enxgmQEXo9RO)：科普到位。搜索作者发现另外一篇（ta共两个帖子）是“[IC] PanCake Dial 磁编码盘式旋钮”，看来文章末尾说的计划烂尾了
<details>
<summary>文章备份</summary>

```
Hi~ 大家好，我是Egahp，Phage Studio的创始人（后面准备好会与大家正式见面），喜欢做些奇奇怪怪东西，不喜欢重复的一个人。

  在这个帖子里，我将为大家介绍一下键盘延迟的小知识，如有不对请指出

  其实很多人都被误导了，认为轮询率（刷新率）就是延迟，实际那并不是延迟。

键盘延迟由这几部分组成

1.轴体触发延迟

2.电路延迟

3.去抖延迟（可避免）

4.数据处理延迟

5.数据链路传输延迟

6.PC端处理延迟

接下来我们逐个介绍延迟

一、首先是轴体触发延迟
这个比较好理解，主要跟键程有关，其次是跟弹簧压力，结构有关，从开始按下到电路第一次闭合，这段时间，称作轴体触发延迟，这个延迟是轴体带来的，机械轴，薄膜轴，光轴，磁轴都无法避免这个，注意这个是从按下动作开始到电路闭合，磁轴可以调节触发键程所以可以调节这部分延迟，比较典型的cherry银轴也是因为短键程才被称为适合游戏，降低弹簧压力可以以一定程度上降低这个延迟，举个栗子，两个相同的G黄，一个是正常的62.5g弹簧，一个是窗总的打火机弹簧，啊这，短键程低压力降低了轴体触发延迟，但提高了误触的概率。


二、然后是电路延迟

  那个懂哥之前提到过 “优化响应速度靠电容矩阵”，我猜他应该是了解了一点关于硬件去抖动的知识，只是有点偏差。众所周知，实际条件不是理想条件，电路必定存在一定的寄生电感电容，这对延迟有一定的影响，所谓的硬件去抖电路主要有两种，其中一种是RC组成的按键去抖电路，利用电容两端电压不能突变，来去除抖动，同样硬件去抖存在很多缺点，比如电容的容值选取如果太小导致无法完全去除抖动，太大导致触发延迟，详细原理可以了解这个    https://wenku.baidu.com/view/17756ab2dd36a32d7275815b.html?from=search，另一种使用RS触发器，但只适合少量按键不适合用作键盘。

理想的按键按下抬起应该是方波，但实际上是在上升沿和下降沿有反复的波形，并且是有一定时间的，

  我简单画了几个图表示下电路延迟，这部分延迟无法完全避免，寄生电容电感会一直存在，但是这部分延迟极小，可以忽略（ns级别）

  这是理想的按键按下与抬起 是方波

  这是不计抖动的近似表示图，上升沿必须上升到H才会被识别为高电平，下降沿同理，所以会有一段延迟，极小极小。

三、接下来我们讨论导致延迟的罪魁祸首之一之去抖延迟

  由于机械轴触发原理是两弹片互相接触导致电路短路，机械接触难以避免弹性碰撞，闭合的时候将有一段极小的时间，几毫秒至几十毫秒，这段时间的长度与轴的触发原理质量等都有关，如果是好点的MX结构轴一般都能保持在5ms以内，而普通的按键，可能会有20ms。

我也画了一张图来近似表示

接下来讲一下常用软件去抖方法之延迟去抖原理。

  当我们读取到电平为底（低于红线）的时候我们认为按键按下，读取到电平为高（高于绿线）的时候我们按键按下。

  1.软件无处理会如何？ 程序是极快的 每秒可以扫描几千次，扫描一次矩阵只需要0.x ms的时间，当我们读取低电平随后就是抖动期，不加处理，我们会在抖动期内多次读取到未知结果，可能是高也可能是低这将导致软件判定为多次重复按下抬起动作造成连击。

  2.延迟去抖，当我们读取到低电平，我们将延迟5ms 此时抖动期已经结束，再次读取如果是低电平，那么说明按键被按下，这样二次判断+延迟，就避免了连击的情况，但是这个方法有一个致命缺点，它引入了延迟，并且相当大。

 3.未命名的算法，当按键按下前会有抖动，倘若按键没有按下还会有吗？当然没有，当我们按下的时候程序读取到低电平，随后我们让软件判定为按下。那我们还在抖动期内，程序下一次扫描扫描的结果不确定，怎么办呢，那我们就让程序放弃一段时间内的读取结果比如5ms，这样我们度过了抖动期，在第一次电平被拉低的时候就判定了按键是按下的。我们再来看看抬起，同理我们第一次读取到高电平之后就判定按键抬起，放弃一段时间后的读取结果，这样我们就没有引入延迟。实际上这样做会怎么样呢，如果有足够理想的轴，和足够快的人，他能办到只保持按键按下5ms以内，那么这个程序将会忽略掉他的抬起，但是不存在这么快的人，也不存在回弹只需要5ms的轴，所以并不会造成丢键。

  到这里就是导致延迟的罪魁祸首之一 抖动。


四、数据处理延迟

  一个好的算法可以让数据处理相当快，一个差的算法也会导致速度非常慢，甚至丢键，这方面与具体的固件还有主控有关，举个简单的栗子，Atmel公司的32U4，一个8位单片机主频16Mhz，对比ST公司STM32系列中的一个型号STM32F411CCU6，一个32位Arm Cortex-M4 内核单片机 主频最大96Mhz（可以超频），我想大家都明白，如此悬殊的差异。

将8位机与32位机对比是不寻常的。因为几乎没有可比性。

  而量产键盘的呢，量产键盘绝大多数都是定制芯片，为了什么？当然是降低成本。当然也不乏比较高端的产品，小米游戏键盘我记得是stm32单片机。罗技的Light Speed 我记得是NRF52832（忘记了）同样是32位 Arm Cortex-M4F 内核单片机 主频64Mhz，另外一提因为是无线所以里面运行了协议栈，占用了相当多的资源。


在举出一个栗子，如高斯某RGB方案双模键盘，IKBC某RGB方案双模键盘，采用的是专门用于RGB键盘的一款定制芯片，这个芯片的矩阵与RGB矩阵是相连的，利用时分复用（不同时刻干不同的事）来读取矩阵信息与控制RGB，大家可以想象一下。多模是通过协议（USART、SPI、I2C）来链接外置一个蓝牙芯片，处理后在发出。

好了这部分不继续扯了


五、数据链路传输延迟

  好！很有精神，你看到这里了！这里是导致延迟的罪魁祸首之一，无线与有线的区别在这里才会真正体现出来。

我先来为大家介绍几个名词：

  1 USB协议 Universal Serial Bus 通用串行总线

  2 HID协议 Human Interface Device  人机交互设备

  3 BLE   Bluetooth Low Energy  蓝牙低功耗

有线键盘是通过USB HID协议，蓝牙键盘是通过BLE里HID Over Gatt协议，而2.4G协议（这里指三模中的另一个无线模式，下文统称2.4G协议键盘，其实蓝牙也是2.4G）呢？

  2.4G协议无线键盘，均配备了一个USB接收器，键盘发送数据给接收器，接收器在通过USB HID协议传给PC端，在接收器这里实际等同于一个有线键盘（收发数据方面）

  好！ 我们接着继续。

  有线键盘

  有线键盘是通过USB HID协议的，并且是USB1.1（USB2.0 Full Speed） 设备，HID协议是1.1版本。

  当我们在开发键盘的时候，有一个参数 是Interval 这个就是轮询率，什么是轮询率？高了好还是低了好？

我们常见1000Hz 800Hz 500Hz 125 Hz这几种，当轮询率越高，键盘可以越短的间隔发送数据，注意这里是间隔，实际上1000Hz轮询率，轮询周期就是1ms，代表我们最少也要间隔1ms 才能第二次发送数据给PC端，轮询率代表的是上限，注意是上限，实际上很多键盘完全就无法做到能间隔1ms 发送两个数据包，但仍然轮询间隔是1ms（轮询率1000Hz）这是为什么，因为轮询间隔是上限，下限是无穷时间，到这里大家应该明白轮询率究竟是什么了，轮询率规定的是，数据包传输间隔，倘若发送数据频率高于轮询率，那么就会丢包。

  我们再来讲一下6键无冲键盘与全键无冲键盘，HID协议规定了标准键盘的数据格式，即为六件无冲键盘，有人认为USB协议不如PS2协议，无法实现真正的全键无冲，大错特错，仅仅是标准键盘无法实现真正全键无冲。

全键无冲有多种实现方法，这个就不深入讨论了，涉及的内容比较复杂，一种是多Interface法，通过将多个USB标准键盘复合成一个设备实现的，这就出现了所谓的全键无冲（26键无冲）键盘，另一种方法是修改HID报告描述符的Bit Map法，此为真正全键无冲键盘，即使所有按键都按下也不会冲突，并且也不像多Interface 法弹出多个键盘来（设备管理器能看到一些26键无冲其实是好几个键盘）

  好！好累，我们继续

  蓝牙键盘

  BLE5.0 BLE4.2 Gatt （Generic Attribute Profile），这些都是什么啊，BLE是一项蓝牙技术，称为低功耗蓝牙，Gatt是蓝牙的上层协议之一，SIG联盟规定了一系列的Profile ，用以快速创建蓝牙应用。（话有点散）

我们来探讨下蓝牙键盘的延迟，BLE 同样有一个Interval参数，这个参数有上限，最快是7.5ms，这个是什么呢，

这个类似与轮询率，但与轮询率又略微不一样，PC端与键盘会每隔7.5ms 交换一次数据确保链接与数据传输，当我们要发送数据，协议栈会自动处理，等到下一次交换数据的时候发送出去，所以蓝牙的协议传输延迟是0-7.5ms，恰好要交换数据的时候要发送数据与恰好交换完数据要发送数据，注意这仅仅是理想情况，实际上还有额外的数据处理时间，空中传输延迟，丢包重发引入的额外延迟，选择信道等一系列状况，所以蓝牙键盘是难以与有线键盘相提并论的。

  来，最后一个，2.4G 协议键盘

  诸如有名的 优联 LightSpeed等，罗技LightSpeed是在Nrf的2.4g协议栈上开发的，我们先分析下啊，有线键盘->线缆->USB HID协议->PC端，罗技LightSpeed 键盘->2.4G私有协议->线缆->USB HID协议->PC 端,我想看到这里大家都明白了，2.4G协议键盘本质上上限是比不上有线的（废话），但是为什么仍然体验良好呢，那是因为这是上限，垃圾有线 跟 LightSpeed 毫无可比性。2.4G协议栈可以规定Interval 更短，而且罗技有十分先进的抗干扰跳频算法等一系列措施，所以虽然2.4G上限没有有线高，但也是能力压绝大部分所谓的有线游戏键盘了。

有线之间也是有天壤地别的差距的，要把有可比性的东西放在一起比较。


6.PC端处理延迟

    大家动动双手，我们来做一个实验，大家打开任务管理器页面，点到性能标题栏，我们只关注CPU的占用率，鼠标回报率（轮询率（刷新率））调整到最高，然后在鼠标垫上画圈，注意不能停下来，要连贯流畅的花圈，现在盯紧你的CPU占用率，反复实验几次，大家应该心中都有自己的结论了。

    为什么垃圾电脑打游戏鼠标偶尔没反应？那是因为CPU不够用了啊，键盘鼠标手柄之类的设备，属于系统占用的输入设备，需求有较高的实时性，这类设备优先级较高，大量的输入会导致CPU分配更多资源来处理。

    PC端处理延迟，这个不应写在键盘延迟里，但我还是写了，你用一个垃圾CPU现在运行这一堆应用，CPU占用率达到100%，与一台3990x 空闲的PC机比较，即便是相同键盘延迟当然也不同了。


    好了，到此结束，一次性写完有点累，辛苦大家看到这里，如有错误请指出，点个赞哦，下一期将会写写，如何花25元买一个设备测试键盘的延迟。 
```
</details>

[【干货】如何测试键盘延迟 | 机械键盘按键延迟的原理 六6鱼 2022-10-06](https://www.bilibili.com/video/BV12D4y1y7Jp):后半部分是自制，前半部分感觉是楼上的洗稿。程序和pcb暂未开源，无法重复实验过程。控制变量测量了一下，总的来说 2.4g 赢 BLE。logi G613  lightspeed 4.86ms BLE 12.05ms. logi K835 TKL 20.86ms. DIY tmk 小键盘 15.73ms

[实测键盘回报率与输入延迟的关系：125，250，500，1000Hz USB vs PS2 _问天_ 2020-07-16](https://www.bilibili.com/video/BV1pz411v7P5)
> 1. 专门的游戏键盘延迟低，罗技、雷蛇、赛睿、海盗船，HyperX，冰豹。
> 2. 改注册表没用

[为什么 USB 键盘会有键冲而 PS2 的键盘能全键无冲？](https://www.zhihu.com/question/21377540):HIDv1.11 协议默认支持6键无冲，全键无冲需要自己写Descriptors，但这样会存在兼容性问题。

[HID 搜索 in USB-IF](https://www.usb.org/documents?search=HID&items_per_page=50)